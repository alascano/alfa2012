****Y2K****

PROCEDURE CUMDOC(COMX,CAMP)
FOR Q=1 TO LEN(TCOD)
    DO CASE
       CASE TCOD[Q]=0
         EXIT
       CASE COMM='FC'.AND.TREM[Q]#0.AND.TIPM='V'
         LOOP 	 
       CASE COMM='FC'.AND.TIPM='C'
	 CANM=TCAN[Q]-TBAJ[Q]
	 IF CANM=0
	    LOOP
	 ENDIF       
       OTHERWISE
         CANM=TCAN[Q]
    ENDCASE
    ARTX=TCOD[Q]
    BAJM=0
    BAJR=0
    SEEK STR(TCOD[Q],LART)+STR(CODM,4)
    WHILE CANM>0.AND.ART=TCOD[Q].AND.COD=CODM.AND.!EOF()
       RESP=0
       BLOQUEAREG(0)
       DO CASE
          CASE (COMX='PV'.OR.COMX='PC'.OR.COMX='RC').AND.RET='S'
	    SKIP
	    LOOP
          CASE COMX='PV'.AND.DESP#DES
	    SKIP
	    LOOP
          CASE COMX='PV'.AND.RES>0 && HAY RESERVA EN EL PEDIDO
	    IF CANM>=RES
	       RESP=RES
	    ELSE
	       RESP=CANM   
	    ENDIF
       ENDCASE
       IF CANM>=CAN
          CANX=CAN
       ELSE
          CANX=CANM
       ENDIF	  	  
       CANM-=CANX
       BAJM+=CANX
       BAJR+=RESP
       IF CAN=CANX
          DELETE
       ELSE
          REPL CAN WITH CAN-CANX
	  IF COMX='PV'.AND.RESP>0
             REPL RES WITH RES-RESP
	  ENDIF   
       ENDIF	  
       GRADEL(COMX)
       SKIP
    ENDDO
    TBAJ[Q]=BAJM
    DO CASE
       CASE COMX='PV'.AND.BAJR>0
	  SELE 2
	  SEEK TCOD[Q]
	  IF FOUND()
	     BLOQUEAREG(0)
	     REPL RES WITH RES-BAJR
	  ENDIF
	  SELE 1
       CASE COMX#'PV'.AND.COMX#'PC'.AND.BAJM>0
	  SELE 2
	  SEEK TCOD[Q]
	  IF FOUND()
	     BLOQUEAREG(0)
	     REPL &CAMP WITH &CAMP-BAJM
	  ENDIF
	  SELE 1
    ENDCASE
NEXT
RETURN

******************************************************************************
PROCEDURE DELDOC
IF FEXM<FECSTOM
   RETURN
ENDIF   
ABREPPC=0
COMA='  '
SELE 3
IF TIPM='V'
   USE &BVTA INDEX &ICVTA SHARED
ELSE
   USE &BCOM INDEX &ICCOM SHARED
ENDIF   
WHILE .T.
   SEEK STR(CODM,4)+COMM+STR(NROM,8)
   IF !FOUND()
      EXIT
   ENDIF
   COMX=COX
   NROX=NRX
   FECX=FEC
   ARTM=ART
   PREM=PRE
   DE1M=DE1
   DE2M=DE2
   CANM=CAN
   IF TIPM='V'
      OBSG=OBS
      CPRX=CPR
      PCOX=PCO
      DESG=DES
      TMOG=TMO
      ORDG=ORD
      CUMX=CUM
      IF DESPEVM=1
         NPEX=NPE
      ENDIF
   ENDIF   
   SELE 1
   DO CASE
      CASE COMA=COMX
      CASE COMX='PV'
        CAMP='XXX'
        USE &BPEV INDEX &IXPEV,&IAPEV,&IOPEV SHARED
      CASE COMX='DV'
        CAMP='DEV'
        USE &BDEV INDEX &IXDEV,&IADEV SHARED
      CASE COMX='RV'
        CAMP='REV'
        USE &BREV INDEX &IXREV,&IOREV SHARED
      CASE COMX='PC'
        CAMP='XXX'
        USE &BPEC INDEX &IXPEC,&IAPEC,&ICPEC SHARED
      CASE COMX='RC'
        CAMP='REC'
        USE &BREC INDEX &IXREC,&IAREC,&ICREC SHARED
      CASE COMX='DC'
        CAMP='DEC'
        USE &BDEC INDEX &IXDEC,&IADEC,&ICDEC SHARED
   ENDCASE
   COMA=COMX
   IF COMX='PV'.AND.TIPM='C'                    && SE QUITA EL STOCK QUE SE
      SEEK STR(PREM,4)+STR(NROX,8)+STR(ARTM,LART)  && REPARTIO EN PEDIDOS DE VTA
      IF FOUND()                                && Y RESERVA EN STOCK POR EL
         BLOQUEAREG(0)                          && COMPROBANTE QUE SE ANULA
	 REPL RES WITH RES-CANM
	 DO DELPEV
      ENDIF
   ELSE
      SEEK STR(CODM,4)+STR(NROX,8)+STR(ARTM,LART)
      IF !FOUND()
	 INSERTAREG(0)
	 REPL COD WITH CODM,NRO WITH NROX
	 REPL ART WITH ARTM,FEC WITH FECX
	 IF COMX#'PV'
	    REPL PRE WITH PREM,DE1 WITH DE1M,DE2 WITH DE2M
	 ENDIF
	 IF COMX='DV'.OR.COMX='RV'
	    REPL CPR WITH CPRX,PCO WITH PCOX,OBS WITH OBSG
	 ENDIF
	 IF COMX='RV'.OR.COMX='PV'
	    REPL DES WITH DESG,TMO WITH TMOG
            REPL ORD WITH ORDG,CUM WITH CUMX
	 ENDIF   
	 IF DESPEVM=1.AND.TIPM='V'
	    REPL NPE WITH NPEX
	 ENDIF
      ELSE
	 BLOQUEAREG(0)
      ENDIF
      REPL CAN WITH CAN+CANM
      DO CASE
         CASE CAMP#'XXX'
	   SELE 2
	   SEEK ARTM
	   IF FOUND()
	      BLOQUEAREG(0)
	      REPL &CAMP WITH &CAMP+CANM
	   ENDIF
      ENDCASE
   ENDIF
   SELE 3
   BLOQUEAREG(0)
   DELETE 
ENDDO
CLOSE DATA
RETURN

******************************************************************************
PROCEDURE GRADEL(COMZ)
NROX=NRO
FECX=FEC
DO CASE
   CASE COMZ='PV'.AND.TIPM='C' && SE GUARDA EL CODIGO DE CLIENTE DEL PEDIDO
     PREX=COD                  && DE VENTA AL QUE SE LE REPARTIO PRODUCTOS
   CASE COMZ#'PV'
     PREX=PRE
     DE1X=DE1
     DE2X=DE2
ENDCASE  
IF COMZ='PV'.OR.COMZ='RV'
   DESG=DES
   TMOG=TMO
   CUMX=CUM
   ORDG=ORD
ENDIF 
IF COMZ='DV'.OR.COMZ='RV'
   CPRX=CPR
   PCOX=PCO
   OBSG=OBS
ENDIF
IF TIPM='V'.AND.DESPEVM=1
   NPEX=NPE
ENDIF
SELE 3
INSERTAREG(0)
REPL COD WITH CODM,CAN WITH CANX
REPL COM WITH COMM,NRO WITH NROM
REPL COX WITH COMZ,NRX WITH NROX
REPL FEC WITH FECX,ART WITH ARTX
IF EMPCATM=0.AND.TIPM='V'.AND.(COM='FC'.OR.COM='NC')
   REPL SUC WITH SUCM,CAT WITH IVAM
ENDIF
DO CASE
   CASE COMZ='PV'.AND.TIPM='C' && SE GUARDA EL CODIGO DE CLIENTE DEL PEDIDO
     REPL PRE WITH PREX        && DE VENTA AL QUE SE LE REPARTIO PRODUCTOS
   CASE COMZ#'PV'
     REPL DE1 WITH DE1X,DE2 WITH DE2X,PRE WITH PREX
ENDCASE
IF TIPM='V'.AND.(COMZ='PV'.OR.COMZ='RV')
   REPL DES WITH DESG,TMO WITH TMOG
   REPL ORD WITH ORDG,CUM WITH CUMX
ENDIF
IF COMZ='DV'.OR.COMZ='RV'
   REPL CPR WITH CPRX,PCO WITH PCOX,OBS WITH OBSG
ENDIF
IF TIPM='V'.AND.DESPEVM=1
   REPL NPE WITH NPEX
ENDIF
SELE 1
RETURN

